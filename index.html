<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>班表</title>
  <link rel="stylesheet" href="https://cdn.anssl.cn/bootstrap/css/bootstrap.min.css" integrity="sha256-2FMn2Zx6PuH5tdBQDRNwrOo60ts5wWPC9R8jK67b3t4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.anssl.cn/bootstrap-icons/font/bootstrap-icons.min.css" integrity="sha256-wefUyJrB+p0O/ADxCplCWnk9z+gX2ODyuv3lm8eDGk4=" crossorigin="anonymous">
  <script src="https://cdn.anssl.cn/bootstrap/js/bootstrap.bundle.min.js" integrity="sha256-5P1JGBOIxI7FBAvT/mb1fCnI5n/NhQKzNUuW7Hq0fMc=" crossorigin="anonymous"></script>
</head>

<body class="min-vh-100" style="background: linear-gradient(135deg, var(--bs-primary-bg-subtle) 0%, var(--bs-purple) 100%)">

  <div class="container px-0 py-2 px-md-4 py-md-4">
    <!-- 日历主体 -->
    <div class="bg-light bg-opacity-75 mx-2 mx-md-0 p-2 p-md-4 p-lg-5 border border-light border-opacity-50 rounded shadow-lg">
      <!-- 标题和控制区域 -->
      <div class="row align-items-center mb-2 mb-md-4 g-2">
        <!-- 左侧标题和日期 -->
        <div class="col-12 col-md-8">
          <div class="small text-body" id="current-date"></div>
        </div>

        <!-- 右侧：班组选择 + 按钮 -->
        <div class="col-12 col-md-4">
          <div class="d-flex gap-3 justify-content-start justify-content-md-end align-items-center">
            <div class="d-flex align-items-center gap-2">
              <span class="small text-body">班组</span>
              <select class="form-select form-select-sm w-auto" id="shiftGroup">
                <option value="A" selected>A班</option>
                <option value="B">B班</option>
                <option value="C">C班</option>
                <option value="D">D班</option>
              </select>
            </div>

            <button class="btn btn-outline-primary" id="prevMonth">
              <i class="bi bi-chevron-left"></i><span class="d-none d-lg-inline ms-1">上月</span>
            </button>
            <button class="btn btn-primary" id="todayBtn">
              <i class="bi bi-house"></i><span class="d-none d-lg-inline ms-1">今天</span>
            </button>
            <button class="btn btn-outline-primary" id="nextMonth">
              <span class="d-none d-lg-inline me-2">下月</span><i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- 日历容器 -->
      <div class="row">
        <div class="col-12">
          <div id="calendar"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.anssl.cn/fullcalendar-6.1.20/index.global.min.js" integrity="sha256-sQEgS6I+FEeOlX4oTVi7qW/HMRAh0O6vifpeZXIMRsg=" crossorigin="anonymous"></script>

  <script>
    class ShiftCalendar {
      constructor() {
        // 默认 A 班
        this.group = 'A';

        // 每个班组的“锚点”：保证切换后循环对齐（长期循环，不限月份）
        // 规则：所有班组都是 白 → 夜 → 休 → 休 的 4 天游程
        // 要求：
        // A：2026-01-01 09:00-18:00 白班
        // B：2026-01-01 18:00-次日09:00 夜班
        // C：2026-01-02 09:00-18:00 白班
        // D：2026-01-02 18:00-次日09:00 夜班
        this.groupAnchors = {
          A: { date: '2026-01-01', index: 0 }, // 0=白,1=夜,2=休,3=休
          B: { date: '2026-01-01', index: 1 },
          C: { date: '2026-01-02', index: 0 },
          D: { date: '2026-01-02', index: 1 }
        };

        this.shiftTypes = [
          { icon: 'bi-sun-fill', name: '白班' },         // 0
          { icon: 'bi-moon-stars-fill', name: '夜班' },  // 1
          { icon: 'bi-cup-hot', name: '休息' },          // 2
          { icon: 'bi-cup-hot', name: '休息' }           // 3
        ];

        this.calendar = null;
        this.init();
      }

      init() {
        this.updateDateTime();
        this.setupEventListeners();
        this.initCalendar();
        setInterval(() => this.updateDateTime(), 1000);
      }

      // 顶部日期：去掉“日”（不影响“星期日”）
      updateDateTime() {
        const now = new Date();
        const parts = new Intl.DateTimeFormat('zh-CN', {
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'long'
        }).formatToParts(now);

        const get = (type) => parts.find(p => p.type === type)?.value || '';
        const year = get('year');
        const month = get('month');
        const day = get('day');
        const weekday = get('weekday');

        // 不拼“日”
        document.getElementById('current-date').textContent = `${year}年${month}${day} ${weekday}`;
      }

      // YYYY-MM-DD（上海时区）
      getShanghaiDateString(date) {
        const formatter = new Intl.DateTimeFormat('en-CA', {
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        return formatter.format(date);
      }

      // 生成 "YYYY-MM-DDTHH:mm:ss+08:00"
      makeShanghaiDateTime(dateStr, hhmmss) {
        return `${dateStr}T${hhmmss}+08:00`;
      }

      addDaysShanghai(dateStr, days) {
        const msPerDay = 24 * 60 * 60 * 1000;
        const d = new Date(dateStr + 'T00:00:00+08:00');
        d.setTime(d.getTime() + days * msPerDay);
        return this.getShanghaiDateString(d);
      }

      generateEvents(start, end) {
        const events = [];
        const msPerDay = 24 * 60 * 60 * 1000;

        // 从 2026-01-01 开始生效
        const workStartDate = new Date('2026-01-01T00:00:00+08:00');

        const anchor = this.groupAnchors[this.group] || this.groupAnchors.A;
        const anchorDate = new Date(anchor.date + 'T00:00:00+08:00');

        // 将 start/end 转为上海日期边界
        const startDateStr = this.getShanghaiDateString(start);
        const endDateStr = this.getShanghaiDateString(end);

        let currentDate = new Date(startDateStr + 'T00:00:00+08:00');
        const endDate = new Date(endDateStr + 'T00:00:00+08:00');

        while (currentDate < endDate) {
          if (currentDate >= workStartDate) {
            const currentDateStr = this.getShanghaiDateString(currentDate);

            // 以“自然日”作为循环步长
            const diffDays = Math.floor((currentDate - anchorDate) / msPerDay);
            const cycleIndex = ((diffDays + anchor.index) % 4 + 4) % 4;
            const shift = this.shiftTypes[cycleIndex];

            if (shift.name === '白班') {
              // 09:00-18:00
              events.push({
                title: shift.name,
                start: this.makeShanghaiDateTime(currentDateStr, '09:00:00'),
                end: this.makeShanghaiDateTime(currentDateStr, '18:00:00'),
                allDay: false,
                backgroundColor: 'transparent',
                borderColor: 'transparent',
                textColor: 'inherit',
                classNames: [],
                extendedProps: { icon: shift.icon, shiftType: shift.name }
              });
            } else if (shift.name === '夜班') {
              // 18:00-次日09:00
              const nextDateStr = this.addDaysShanghai(currentDateStr, 1);
              events.push({
                title: shift.name,
                start: this.makeShanghaiDateTime(currentDateStr, '18:00:00'),
                end: this.makeShanghaiDateTime(nextDateStr, '09:00:00'),
                allDay: false,
                backgroundColor: 'transparent',
                borderColor: 'transparent',
                textColor: 'inherit',
                classNames: [],
                extendedProps: { icon: shift.icon, shiftType: shift.name }
              });
            } else {
              // 休息：全天显示，保持你原来的“格子里有标记”体验
              events.push({
                title: shift.name,
                start: currentDateStr,
                allDay: true,
                backgroundColor: 'transparent',
                borderColor: 'transparent',
                textColor: 'inherit',
                classNames: [],
                extendedProps: { icon: shift.icon, shiftType: shift.name }
              });
            }
          }

          currentDate.setTime(currentDate.getTime() + msPerDay);
        }

        return events;
      }

      initCalendar() {
        const calendarEl = document.getElementById('calendar');

        this.calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          themeSystem: 'bootstrap5',
          timeZone: 'Asia/Shanghai',
          initialDate: new Date(),
          headerToolbar: { left: '', center: 'title', right: '' },
          locale: 'zh-cn',
          firstDay: 1,
          height: 'auto',
          fixedWeekCount: false,
          showNonCurrentDates: true,
          dayMaxEvents: false,
          moreLinkText: '更多',
          noEventsText: '暂无排班',
          eventDisplay: 'block',

          // 月视图不显示时间（仍是“白班/夜班/休息”）
          displayEventTime: false,

          events: (info, successCallback) => {
            successCallback(this.generateEvents(info.start, info.end));
          },

          eventContent: (arg) => {
            const icon = arg.event.extendedProps.icon;
            const title = arg.event.title;
            const shiftType = arg.event.extendedProps.shiftType;

            let colorClass = '';
            if (shiftType === '白班') {
              colorClass = 'text-warning';
            } else if (shiftType === '夜班') {
              colorClass = 'text-dark';
            } else if (shiftType === '休息') {
              colorClass = 'text-success';
            }

            return {
              html: `
                <div class="d-flex flex-column flex-md-row align-items-center justify-content-center gap-1 gap-md-2 p-1" style="border: none; background: transparent;">
                  <i class="bi ${icon} ${colorClass} fs-6"></i>
                  <span class="${colorClass} fw-bold">${title}</span>
                </div>
              `
            };
          },

          eventDidMount: (info) => {
            // 今日高亮：因为现在事件 start 带时间，所以用“日期字符串”比对
            const today = this.getShanghaiDateString(new Date());
            const eventDay = this.getShanghaiDateString(info.event.start);

            // 清除默认样式
            info.el.style.border = 'none';
            info.el.style.background = 'transparent';
            info.el.style.boxShadow = 'none';

            if (eventDay === today) {
              info.el.classList.add('border', 'border-warning', 'border-2', 'rounded');
              info.el.style.background = 'rgba(var(--bs-warning-rgb), 0.1)';

              const iconEl = info.el.querySelector('i');
              const textEl = info.el.querySelector('span');
              if (iconEl) {
                iconEl.classList.add('fs-5');
                iconEl.style.filter = 'brightness(1.2)';
              }
              if (textEl) {
                textEl.classList.add('fw-bold', 'fs-6');
              }
            }

            // 悬停效果（保留你原来的）
            info.el.addEventListener('mouseenter', () => {
              info.el.style.transform = 'scale(1.05)';
              info.el.style.zIndex = '100';
              info.el.style.transition = 'all 0.2s ease';
            });

            info.el.addEventListener('mouseleave', () => {
              info.el.style.transform = 'scale(1)';
              info.el.style.zIndex = '1';
            });
          },

          datesSet: () => {
            this.beautifyCalendarWithBootstrap();
          },
        });

        this.calendar.render();
      }

      beautifyCalendarWithBootstrap() {
        // 美化周几标题
        const headerCells = document.querySelectorAll('.fc-col-header-cell');
        headerCells.forEach(cell => {
          cell.classList.add('bg-secondary-subtle');
          const cushion = cell.querySelector('.fc-col-header-cell-cushion');
          if (cushion) {
            cushion.classList.add('text-secondary-emphasis', 'fw-semibold', 'text-decoration-none', 'py-2');
            cushion.style.letterSpacing = '0.5px';
          }
        });

        // 美化日期数字
        const dayNumbers = document.querySelectorAll('.fc-daygrid-day-number');
        dayNumbers.forEach(dayNumber => {
          const dayCell = dayNumber.closest('.fc-daygrid-day');

          dayNumber.classList.add('text-info-emphasis', 'rounded', 'px-2', 'py-1', 'fs-6', 'text-decoration-none');
          dayNumber.style.transition = 'all 0.2s ease';

          // 今日
          if (dayCell && dayCell.classList.contains('fc-day-today')) {
            dayNumber.classList.remove('text-muted');
            dayNumber.classList.add('text-bg-warning', 'text-dark', 'fw-bold', 'shadow-sm');
          }

          // 周末
          if (dayCell && (dayCell.classList.contains('fc-day-sat') || dayCell.classList.contains('fc-day-sun'))) {
            dayNumber.classList.remove('text-muted');
            dayNumber.classList.add('text-bg-danger');
          }

          // 其他月份
          if (dayCell && dayCell.classList.contains('fc-day-other')) {
            dayNumber.classList.add('text-muted', 'opacity-75');
          }

          dayNumber.addEventListener('mouseenter', () => {
            if (!dayCell.classList.contains('fc-day-today')) {
              dayNumber.classList.add('bg-primary', 'bg-opacity-10', 'text-body');
            }
            dayNumber.style.transform = 'scale(1.1)';
          });

          dayNumber.addEventListener('mouseleave', () => {
            if (!dayCell.classList.contains('fc-day-today')) {
              dayNumber.classList.remove('bg-primary', 'bg-opacity-10', 'text-primary');
            }
            dayNumber.style.transform = 'scale(1)';
          });
        });

        // 美化月份标题
        const title = document.querySelector('.fc-toolbar-title');
        if (title) {
          title.classList.add('text-secondary', 'fw-bold');
        }

        // 美化日历边框
        const dayCells = document.querySelectorAll('.fc-daygrid-day');
        dayCells.forEach(cell => {
          cell.classList.add('border-light', 'border-opacity-50');
        });
      }

      setupEventListeners() {
        document.getElementById('prevMonth')?.addEventListener('click', () => {
          this.calendar?.prev();
        });

        document.getElementById('nextMonth')?.addEventListener('click', () => {
          this.calendar?.next();
        });

        document.getElementById('todayBtn')?.addEventListener('click', () => {
          this.calendar?.today();
        });

        // 班组切换：刷新事件（日期对齐由锚点保证）
        document.getElementById('shiftGroup')?.addEventListener('change', (e) => {
          this.group = e.target.value || 'A';
          this.calendar?.refetchEvents();
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') this.calendar?.prev();
          if (e.key === 'ArrowRight') this.calendar?.next();
          if (e.key === 'Home') this.calendar?.today();
        });
      }
    }

    // 初始化应用
    document.addEventListener('DOMContentLoaded', () => {
      new ShiftCalendar();

      // 添加页面加载动画（你原来写的，保留）
      document.querySelectorAll('.animate-fade-in').forEach((el, index) => {
        el.style.animationDelay = `${index * 0.15}s`;
      });
    });
  </script>
</body>

</html>
