<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>班表</title>
  <meta name="theme-color" content="#0d6efd">
  <meta name="mobile-web-app-capable" content="yes">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="班表">

  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180.png">

  <link rel="stylesheet" href="https://cdn.anssl.cn/bootstrap/css/bootstrap.min.css" integrity="sha256-2FMn2Zx6PuH5tdBQDRNwrOo60ts5wWPC9R8jK67b3t4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.anssl.cn/bootstrap-icons/font/bootstrap-icons.min.css" integrity="sha256-wefUyJrB+p0O/ADxCplCWnk9z+gX2ODyuv3lm8eDGk4=" crossorigin="anonymous">
  <script src="https://cdn.anssl.cn/bootstrap/js/bootstrap.bundle.min.js" integrity="sha256-5P1JGBOIxI7FBAvT/mb1fCnI5n/NhQKzNUuW7Hq0fMc=" crossorigin="anonymous"></script>
  <script src="https://cdn.anssl.cn/fullcalendar-6.1.20/index.global.min.js" integrity="sha256-sQEgS6I+FEeOlX4oTVi7qW/HMRAh0O6vifpeZXIMRsg=" crossorigin="anonymous"></script>
</head>

<body class="min-vh-100" style="background: linear-gradient(135deg, var(--bs-primary-bg-subtle) 0%, var(--bs-purple) 100%)">
  <div class="container px-0 py-2 px-md-4 py-md-4">
    <div class="bg-light bg-opacity-75 mx-2 mx-md-0 p-2 p-md-4 p-lg-5 border border-light border-opacity-50 rounded shadow-lg">
      <div class="row align-items-center mb-2 mb-md-4 g-2">
        <div class="col-12 col-md-8">
          <div class="small text-body" id="current-date"></div>
        </div>

        <div class="col-12 col-md-4">
          <div class="d-flex gap-3 justify-content-start justify-content-md-end align-items-center flex-nowrap">
            <div class="d-flex align-items-center gap-2 flex-nowrap">
              <span class="small text-body text-nowrap">班次：</span>
              <select class="form-select form-select-sm w-auto" id="shiftGroup">
                <option value="A" selected>A班</option>
                <option value="B">B班</option>
                <option value="C">C班</option>
                <option value="D">D班</option>
              </select>
            </div>

            <button class="btn btn-outline-primary text-nowrap" id="prevMonth">
              <i class="bi bi-chevron-left"></i><span class="d-none d-lg-inline ms-1">上月</span>
            </button>
            <button class="btn btn-primary text-nowrap" id="todayBtn">
              <i class="bi bi-house"></i><span class="d-none d-lg-inline ms-1">今天</span>
            </button>
            <button class="btn btn-outline-primary text-nowrap" id="nextMonth">
              <span class="d-none d-lg-inline me-2">下月</span><i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div id="calendar"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    class ShiftCalendar {
      #calendar = null;
      #group = 'A';

      // 统一基准日：在这一天，四个班组分别处于白/夜/休/休
      #baseDateStr = '2026-01-01';

      // 在 baseDate 这一天，各班组处于循环的哪个位置：0=白 1=夜 2=休 3=休
      // 这样能保证：A(1号白) -> A(2号夜) ✅
      #baseIndexByGroup = {
        A: 0, // 2026-01-01 白班（09-18）
        B: 1, // 2026-01-01 夜班（18-次日09）
        C: 2, // 2026-01-01 休息
        D: 3  // 2026-01-01 休息（第二个休）
      };

      #shiftTypes = [
        { icon: 'bi-sun-fill', name: '白班', startTime: '09:00', endTime: '18:00' },
        { icon: 'bi-moon-stars-fill', name: '夜班', startTime: '18:00', endTime: '09:00' },
        { icon: 'bi-cup-hot', name: '休息' },
        { icon: 'bi-cup-hot-fill', name: '休息' }
      ];

      #bgMap = {
        '白班': 'bg-secondary-subtle',
        '夜班': 'bg-dark-subtle',
        '休息': 'bg-success-subtle',
      };

      constructor() {
        const saved = localStorage.getItem('shiftGroup') || 'A';
        this.#group = (['A','B','C','D'].includes(saved) ? saved : 'A');
        const sel = document.getElementById('shiftGroup');
        if (sel) sel.value = this.#group;

        this.#updateDateTime();
        this.#setupEventListeners();
        this.#initCalendar();
        setInterval(() => this.#updateDateTime(), 1000);
      }

      #updateDateTime() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'long'
        });
        document.getElementById('current-date').textContent = dateStr;
      }

      #getShanghaiDateString = (date) => {
        const fmt = new Intl.DateTimeFormat('en-CA', {
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        return fmt.format(date);
      };

      #addDaysShanghai = (dateStr, days) => {
        const msPerDay = 24 * 60 * 60 * 1000;
        const d = new Date(`${dateStr}T00:00:00+08:00`);
        d.setTime(d.getTime() + days * msPerDay);
        return this.#getShanghaiDateString(d);
      };

      #mod = (n, m) => ((n % m) + m) % m;

      // ✅ 给定 YYYY-MM-DD，算该班组当天是白/夜/休（支持往前推：2025-12-31 也能算）
      #getShiftForDay = (dateStr) => {
        const msPerDay = 24 * 60 * 60 * 1000;

        const baseDate = new Date(`${this.#baseDateStr}T00:00:00+08:00`);
        const d = new Date(`${dateStr}T00:00:00+08:00`);

        const diffDays = Math.floor((d - baseDate) / msPerDay);
        const baseIndex = this.#baseIndexByGroup[this.#group] ?? 0;

        const cycleIndex = this.#mod(diffDays + baseIndex, 4);
        return { ...this.#shiftTypes[cycleIndex], cycleIndex };
      };

      // 月视图里统一 allDay：避免夜班跨天渲染成横条“溢出”
      #generateEvents = (start, end) => {
        const events = [];
        const msPerDay = 24 * 60 * 60 * 1000;

        const startStr = this.#getShanghaiDateString(start);
        const endStr = this.#getShanghaiDateString(end);

        let cur = new Date(`${startStr}T00:00:00+08:00`);
        const endD = new Date(`${endStr}T00:00:00+08:00`);

        while (cur < endD) {
          const dayStr = this.#getShanghaiDateString(cur);
          const shift = this.#getShiftForDay(dayStr);

          events.push({
            title: shift.name,
            start: dayStr,
            allDay: true,
            backgroundColor: 'transparent',
            borderColor: 'transparent',
            textColor: 'inherit',
            extendedProps: {
              icon: shift.icon,
              shiftType: shift.name,
              startTime: shift.startTime ?? null, // 白=09:00 夜=18:00
              endTime: shift.endTime ?? null,     // 白=18:00 夜=09:00
              endDate: shift.name === '夜班' ? this.#addDaysShanghai(dayStr, 1) : null
            }
          });

          cur.setTime(cur.getTime() + msPerDay);
        }
        return events;
      };

      #clearBgOnVisibleCells = () => {
        document.querySelectorAll('.fc-daygrid-day[data-date]').forEach(dayCell => {
          const frame = dayCell.querySelector('.fc-daygrid-day-frame');
          const inner = dayCell.querySelector('.fc-scrollgrid-sync-inner');
          frame?.classList.remove('bg-secondary-subtle', 'bg-dark-subtle', 'bg-success-subtle');
          inner?.classList.remove('bg-secondary-subtle', 'bg-dark-subtle', 'bg-success-subtle');
        });
      };

      // ✅ 直接按可见格子算背景：首屏最上面那排也会显示
      #applyBgForVisibleCells = () => {
        this.#clearBgOnVisibleCells();

        document.querySelectorAll('.fc-daygrid-day[data-date]').forEach(dayCell => {
          const dateStr = dayCell.getAttribute('data-date');
          if (!dateStr) return;

          const shift = this.#getShiftForDay(dateStr);
          const bg = this.#bgMap[shift.name];
          if (!bg) return;

          // 你要求：分别给这两个类加
          const frame = dayCell.querySelector('.fc-daygrid-day-frame');
          const inner = dayCell.querySelector('.fc-scrollgrid-sync-inner');
          frame?.classList.add(bg);
          inner?.classList.add(bg);
        });
      };

      #initCalendar() {
        const calendarEl = document.getElementById('calendar');

        this.#calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          themeSystem: 'bootstrap5',
          timeZone: 'Asia/Shanghai',
          initialDate: new Date(),
          headerToolbar: { left: '', center: 'title', right: '' },
          locale: 'zh-cn',
          firstDay: 1,
          height: 'auto',
          fixedWeekCount: false,
          showNonCurrentDates: true,
          dayMaxEvents: false,
          moreLinkText: '更多',
          noEventsText: '暂无排班',
          eventDisplay: 'block',
          displayEventTime: false,

          // ✅ 只去掉日历格子里的“日”
          dayCellContent: (arg) => {
            const txt = (arg.dayNumberText ?? '').replace('日', '');
            return { html: txt };
          },

          events: (info, successCallback) => {
            successCallback(this.#generateEvents(info.start, info.end));
          },

          datesSet: () => {
            this.#beautifyCalendarWithBootstrap();
            requestAnimationFrame(() => this.#applyBgForVisibleCells());
          },

          eventsSet: () => {
            requestAnimationFrame(() => this.#applyBgForVisibleCells());
          },

          eventContent: (arg) => {
            const { icon, shiftType } = arg.event.extendedProps ?? {};
            const title = arg.event.title;

            let colorClass = '';
            if (shiftType === '白班') colorClass = 'text-warning-emphasis';
            else if (shiftType === '夜班') colorClass = 'text-dark-emphasis';
            else if (shiftType === '休息') colorClass = 'text-success';

            return {
              html: `
                <div class="d-flex flex-column flex-md-row align-items-center justify-content-center gap-1 gap-md-2 p-1" style="border:none;background:transparent;">
                  <i class="bi ${icon ?? ''} ${colorClass} fs-6"></i>
                  <span class="${colorClass} fw-bold">${title}</span>
                </div>
              `
            };
          },

          eventDidMount: (info) => {
            const today = this.#getShanghaiDateString(new Date());
            const eventDay = this.#getShanghaiDateString(info.event.start);

            info.el.style.border = 'none';
            info.el.style.background = 'transparent';
            info.el.style.boxShadow = 'none';

            if (eventDay === today) {
              info.el.classList.add('border', 'border-warning', 'border-2', 'rounded');
              info.el.style.background = 'rgba(var(--bs-warning-rgb), 0.1)';

              const iconEl = info.el.querySelector('i');
              const textEl = info.el.querySelector('span');
              if (iconEl) {
                iconEl.classList.add('fs-5');
                iconEl.style.filter = 'brightness(1.2)';
              }
              if (textEl) {
                textEl.classList.add('fw-bold', 'fs-6');
              }
            }

            info.el.addEventListener('mouseenter', () => {
              info.el.style.transform = 'scale(1.05)';
              info.el.style.zIndex = '100';
              info.el.style.transition = 'all 0.2s ease';
            });

            info.el.addEventListener('mouseleave', () => {
              info.el.style.transform = 'scale(1)';
              info.el.style.zIndex = '1';
            });
          },
        });

        this.#calendar.render();
        requestAnimationFrame(() => this.#applyBgForVisibleCells());
      }

      #beautifyCalendarWithBootstrap() {
        document.querySelectorAll('.fc-col-header-cell').forEach(cell => {
          cell.classList.add('bg-secondary-subtle');
          const cushion = cell.querySelector('.fc-col-header-cell-cushion');
          if (cushion) {
            cushion.classList.add('text-secondary-emphasis', 'fw-semibold', 'text-decoration-none', 'py-2');
            cushion.style.letterSpacing = '0.5px';
          }
        });

        document.querySelectorAll('.fc-daygrid-day-number').forEach(dayNumber => {
          const dayCell = dayNumber.closest('.fc-daygrid-day');

          dayNumber.classList.add('text-info-emphasis', 'rounded', 'px-2', 'py-1', 'fs-6', 'text-decoration-none');
          dayNumber.style.transition = 'all 0.2s ease';

          if (dayCell?.classList.contains('fc-day-today')) {
            dayNumber.classList.remove('text-muted');
            dayNumber.classList.add('text-bg-warning', 'text-dark', 'fw-bold', 'shadow-sm');
          }

          if (dayCell?.classList.contains('fc-day-sat') || dayCell?.classList.contains('fc-day-sun')) {
            dayNumber.classList.remove('text-muted');
            dayNumber.classList.add('text-bg-danger');
          }

          if (dayCell?.classList.contains('fc-day-other')) {
            dayNumber.classList.add('text-muted', 'opacity-75');
          }

          dayNumber.addEventListener('mouseenter', () => {
            if (!dayCell?.classList.contains('fc-day-today')) {
              dayNumber.classList.add('bg-primary', 'bg-opacity-10', 'text-body');
            }
            dayNumber.style.transform = 'scale(1.1)';
          });

          dayNumber.addEventListener('mouseleave', () => {
            if (!dayCell?.classList.contains('fc-day-today')) {
              dayNumber.classList.remove('bg-primary', 'bg-opacity-10', 'text-primary');
            }
            dayNumber.style.transform = 'scale(1)';
          });
        });

        document.querySelector('.fc-toolbar-title')?.classList.add('text-secondary', 'fw-bold');

        document.querySelectorAll('.fc-daygrid-day').forEach(cell => {
          cell.classList.add('border-light', 'border-opacity-50');
        });
      }

      #setupEventListeners() {
        document.getElementById('prevMonth')?.addEventListener('click', () => this.#calendar?.prev());
        document.getElementById('nextMonth')?.addEventListener('click', () => this.#calendar?.next());
        document.getElementById('todayBtn')?.addEventListener('click', () => this.#calendar?.today());

        document.getElementById('shiftGroup')?.addEventListener('change', (e) => {
          const g = (e.target.value || 'A');
          this.#group = (['A','B','C','D'].includes(g) ? g : 'A');
          localStorage.setItem('shiftGroup', this.#group);
          this.#calendar?.refetchEvents(); // eventsSet 会自动重新染色
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') this.#calendar?.prev();
          if (e.key === 'ArrowRight') this.#calendar?.next();
          if (e.key === 'Home') this.#calendar?.today();
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new ShiftCalendar();
    });
  </script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      await navigator.serviceWorker.register('/service-worker.js');

      // 第一次安装/更新后，等接管再刷新一次，让资源走 SW 从而进入缓存
      if (!navigator.serviceWorker.controller) {
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload();
        });
      }
    });
  }
</script>

</body>

</html>
